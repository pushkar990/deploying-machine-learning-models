# Step 6 - Reliable leaf rules using path.rpart
rpart_base = importr('rpart')

# Get paths to leaves
paths = ro.r['path.rpart'](tree, nodes=ro.r['row.names'](tree.rx2('frame')))  # all leaf nodes

# Convert R list to Python
leaf_rules = []
for node, conditions in paths.items():
    rule_text = " & ".join(list(conditions))
    leaf_rules.append({'leaf_id': int(node), 'leaf_rule': rule_text})

leaf_rules_df = pd.DataFrame(leaf_rules)

# Merge with metrics
metrics = metrics.merge(leaf_rules_df, on='leaf_id', how='left')


# ----------------------------
# 6️⃣ Extract human-readable rules per leaf (fixed)
# ----------------------------
# Use labels.rpart to get the leaf paths/rules
# This works even if rpart.rules gave blank output

# Import base rpart functions
rpart_base = importr('rpart')

# Get leaf labels (one rule per leaf)
leaf_labels = ro.r['labels'](tree)  # returns R vector of leaf rules

# Convert to Python list
leaf_rules_list = list(leaf_labels)

# Create a DataFrame mapping leaf_id to leaf_rule
# Ensure number of rules matches metrics['leaf_id']
leaf_rules_df = pd.DataFrame({
    'leaf_id': metrics['leaf_id'].values,
    'leaf_rule': leaf_rules_list
})

# Merge leaf rules with metrics
metrics = metrics.merge(leaf_rules_df, on='leaf_id', how='left')















# In R, get rules with leaf IDs
rules_str = ro.r['capture.output'](rpart_plot.rpart.rules(tree, nn=True))  # nn=True includes node numbers
rules_list = list(rules_str)

# Parse rules into leaf_id and rule string
leaf_rules = []
for line in rules_list:
    if ':' in line:  # typical format: "1) condition1 & condition2 : class=1"
        parts = line.split(':')
        node = parts[0].split(')')[0].strip()  # leaf_id / node number
        rule_text = parts[0].split(')')[1].strip() + ' : ' + parts[1].strip()
        leaf_rules.append({'leaf_id': int(node), 'leaf_rule': rule_text})

leaf_rules = pd.DataFrame(leaf_rules)

# Merge with metrics
metrics = metrics.merge(leaf_rules, on='leaf_id', how='left')
