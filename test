import pandas as pd
import numpy as np

# -----------------------------
# Step 0: Load data
# -----------------------------
df = pd.read_csv("claims.csv")  # Load your claims dataset

# Separate audited (SME-selected) vs non-audited (unaudited) claims
audited = df[~df['find'].isna()].copy()   # Audited claims have 'find' not NaN
unaudited = df[df['find'].isna()].copy()  # Non-audited claims

# Define diagnosis and procedure columns (top 6)
dx_cols = [f'diag{i}' for i in range(1,7)]
proc_cols = [f'proc{i}' for i in range(1,7)]

# -----------------------------
# Step 1: Bin numeric features
# -----------------------------
# Bin LOS into categories for pattern analysis
los_bins = [0,2,5,10,15,1000]  
los_labels = ['VeryShort','Short','Medium','Long','VeryLong']
audited['LOS_bin'] = pd.cut(audited['los'], bins=los_bins, labels=los_labels)
unaudited['LOS_bin'] = pd.cut(unaudited['los'], bins=los_bins, labels=los_labels)

# Bin total paid amount into categories
paid_bins = [0,10000,50000,100000,1000000]
paid_labels = ['Low','Medium','High','VeryHigh']
audited['Paid_bin'] = pd.cut(audited['totalpaidamount'], bins=paid_bins, labels=paid_labels)
unaudited['Paid_bin'] = pd.cut(unaudited['totalpaidamount'], bins=paid_bins, labels=paid_labels)

# -----------------------------
# Step 2: Helper function to create patterns
# -----------------------------
def make_pattern(row, prefix_cols=[], dx_cols=[], proc_cols=[], include_proc=False, add_los=False, add_paid=False):
    """Constructs a pattern string from multiple columns"""
    parts = []

    # Add prefix columns (e.g., aprdrgcode + soi + discharge)
    for c in prefix_cols:
        parts.append(str(row[c]))

    # Add diagnosis columns if provided
    if dx_cols:
        dx_part = "_".join([str(row[c]) if pd.notna(row[c]) else "NA" for c in dx_cols])
        parts.append(dx_part)

    # Add procedure columns if requested
    if include_proc and proc_cols:
        proc_part = "_".join([str(row[c]) if pd.notna(row[c]) else "NA" for c in proc_cols])
        parts.append(proc_part)

    # Add LOS_bin if requested
    if add_los:
        parts.append(str(row['LOS_bin']))

    # Add Paid_bin if requested
    if add_paid:
        parts.append(str(row['Paid_bin']))

    # Join all parts with "_"
    return "_".join(parts)

# -----------------------------
# Step 3: Create patterns for audited data
# -----------------------------
audited['Pattern_Basic'] = audited.apply(lambda x: make_pattern(x, prefix_cols=['aprdrgcode','soi_indicator']), axis=1)
audited['Pattern_Standard'] = audited.apply(lambda x: make_pattern(x, prefix_cols=['aprdrgcode','soi_indicator','dischargestatuscode']), axis=1)
audited['Pattern_Dx'] = audited.apply(lambda x: make_pattern(x, prefix_cols=['aprdrgcode','soi_indicator','dischargestatuscode'], dx_cols=dx_cols), axis=1)
audited['Pattern_Full'] = audited.apply(lambda x: make_pattern(x, prefix_cols=['aprdrgcode','soi_indicator','dischargestatuscode'], dx_cols=dx_cols, proc_cols=proc_cols, include_proc=True), axis=1)

audited['Pattern_Drg_LOS'] = audited.apply(lambda x: make_pattern(x, prefix_cols=['aprdrgcode','soi_indicator','dischargestatuscode'], add_los=True), axis=1)
audited['Pattern_Drg_Paid'] = audited.apply(lambda x: make_pattern(x, prefix_cols=['aprdrgcode','soi_indicator','dischargestatuscode'], add_paid=True), axis=1)
audited['Pattern_Drg_LOS_Paid'] = audited.apply(lambda x: make_pattern(x, prefix_cols=['aprdrgcode','soi_indicator','dischargestatuscode'], add_los=True, add_paid=True), axis=1)

audited['Pattern_LOS'] = audited.apply(lambda x: make_pattern(x, prefix_cols=['soi_indicator','dischargestatuscode'], add_los=True), axis=1)
audited['Pattern_Paid'] = audited.apply(lambda x: make_pattern(x, prefix_cols=['soi_indicator','dischargestatuscode'], add_paid=True), axis=1)
audited['Pattern_LOS_Paid'] = audited.apply(lambda x: make_pattern(x, prefix_cols=['soi_indicator','dischargestatuscode'], add_los=True, add_paid=True), axis=1)

# List of all patterns in priority order
pattern_cols = [
    'Pattern_Basic','Pattern_Standard','Pattern_Dx','Pattern_Full',
    'Pattern_Drg_LOS','Pattern_Drg_Paid','Pattern_Drg_LOS_Paid',
    'Pattern_LOS','Pattern_Paid','Pattern_LOS_Paid'
]

# -----------------------------
# Step 4: Global patterns (all audited claims)
# -----------------------------
global_stats = []

for pat_col in pattern_cols:
    stats = audited.groupby(pat_col).agg(
        Total=('find','count'),
        Hits=('find','sum')
    ).reset_index()
    
    overall_hit_rate = audited['find'].mean()
    stats['Support'] = stats['Total'] / len(audited)
    stats['HitRate'] = stats['Hits'] / stats['Total']
    stats['Lift'] = stats['HitRate'] / overall_hit_rate if overall_hit_rate > 0 else 0
    stats['Pattern_Type'] = pat_col
    stats['Client'] = 'ALL'
    global_stats.append(stats)

global_stats_df = pd.concat(global_stats, axis=0)

# -----------------------------
# Step 5: Client-specific patterns
# -----------------------------
client_stats = []

for client in audited['clientname'].unique():
    client_data = audited[audited['clientname'] == client].copy()
    overall_hit_rate = client_data['find'].mean()
    
    for pat_col in pattern_cols:
        stats = client_data.groupby(pat_col).agg(
            Total=('find','count'),
            Hits=('find','sum')
        ).reset_index()
        stats['Support'] = stats['Total'] / len(client_data)
        stats['HitRate'] = stats['Hits'] / stats['Total']
        stats['Lift'] = stats['HitRate'] / overall_hit_rate if overall_hit_rate > 0 else 0
        stats['Pattern_Type'] = pat_col
        stats['Client'] = client
        client_stats.append(stats)

client_stats_df = pd.concat(client_stats, axis=0)

# -----------------------------
# Step 6: Test patterns on non-audited claims
# -----------------------------
for pat_col in pattern_cols:
    if 'Drg' in pat_col:
        prefix_cols = ['aprdrgcode','soi_indicator','dischargestatuscode']
    elif 'LO' in pat_col or 'Paid' in pat_col:
        prefix_cols = ['soi_indicator','dischargestatuscode']
    else:
        prefix_cols = ['aprdrgcode','soi_indicator']

    dx_list = dx_cols if 'Dx' in pat_col and 'Full' not in pat_col else []
    include_proc = 'Full' in pat_col
    add_los = 'LOS' in pat_col
    add_paid = 'Paid' in pat_col

    unaudited[pat_col] = unaudited.apply(
        lambda x: make_pattern(x, prefix_cols=prefix_cols, dx_cols=dx_list, proc_cols=proc_cols,
                               include_proc=include_proc, add_los=add_los, add_paid=add_paid),
        axis=1
    )

# Count number of unaudited claims matching each pattern
test_stats = []
for pat_col in pattern_cols:
    stats = unaudited.groupby(pat_col).agg(
        NonAuditedCount=('soi_indicator','count')
    ).reset_index()
    stats['Pattern_Type'] = pat_col
    test_stats.append(stats)

unaudited_stats_df = pd.concat(test_stats, axis=0)

# -----------------------------
# Step 7: Save outputs
# -----------------------------
global_stats_df.to_csv("global_pattern_stats.csv", index=False)
client_stats_df.to_csv("client_pattern_stats.csv", index=False)
unaudited_stats_df.to_csv("unaudited_pattern_test.csv", index=False)

print("âœ… Global, client-specific, and unaudited pattern stats saved successfully.")
