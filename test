import pandas as pd
import numpy as np

# -----------------------------
# Load data
# -----------------------------
df = pd.read_csv("claims.csv")

# Identify audited vs non-audited
audited = df[~df['find'].isna()].copy()   # SME-selected
unaudited = df[df['find'].isna()].copy()  # non-SME

# Dx/Proc columns
dx_cols = [f'diag{i}' for i in range(1,7)]
proc_cols = [f'proc{i}' for i in range(1,7)]

# -----------------------------
# Step 0: Bin numeric features
# -----------------------------
los_bins = [0,2,5,10,15,1000]
los_labels = ['VeryShort','Short','Medium','Long','VeryLong']
audited['LOS_bin'] = pd.cut(audited['los'], bins=los_bins, labels=los_labels)
unaudited['LOS_bin'] = pd.cut(unaudited['los'], bins=los_bins, labels=los_labels)

paid_bins = [0,10000,50000,100000,1000000]
paid_labels = ['Low','Medium','High','VeryHigh']
audited['Paid_bin'] = pd.cut(audited['totalpaidamount'], bins=paid_bins, labels=paid_labels)
unaudited['Paid_bin'] = pd.cut(unaudited['totalpaidamount'], bins=paid_bins, labels=paid_labels)

# -----------------------------
# Step 1: Helper function to create patterns
# -----------------------------
def make_pattern(row, dx_cols=[], proc_cols=[], include_proc=False):
    dx_part = "_".join([str(row[c]) if pd.notna(row[c]) else "NA" for c in dx_cols])
    proc_part = "_".join([str(row[c]) if pd.notna(row[c]) else "NA" for c in proc_cols]) if include_proc else ""
    parts = [str(row['soi_indicator']), str(row['dischargestatuscode'])]
    if dx_part: parts.append(dx_part)
    if proc_part: parts.append(proc_part)
    return "_".join(parts)

# -----------------------------
# Step 2: Create patterns for audited data
# -----------------------------
audited['Pattern_Basic'] = audited.apply(lambda x: make_pattern(x), axis=1)
audited['Pattern_Standard'] = audited.apply(lambda x: make_pattern(x, dx_cols=['diag1']), axis=1)
audited['Pattern_Dx'] = audited.apply(lambda x: make_pattern(x, dx_cols=dx_cols), axis=1)
audited['Pattern_Full'] = audited.apply(lambda x: make_pattern(x, dx_cols=dx_cols, proc_cols=proc_cols, include_proc=True), axis=1)
audited['Pattern_LOS'] = audited.apply(lambda x: str(x['soi_indicator']) + "_" + str(x['dischargestatuscode']) + "_" + str(x['LOS_bin']), axis=1)
audited['Pattern_Paid'] = audited.apply(lambda x: str(x['soi_indicator']) + "_" + str(x['dischargestatuscode']) + "_" + str(x['Paid_bin']), axis=1)
audited['Pattern_LOS_Paid'] = audited.apply(lambda x: str(x['soi_indicator']) + "_" + str(x['dischargestatuscode']) + "_" + str(x['LOS_bin']) + "_" + str(x['Paid_bin']), axis=1)

pattern_cols = [
    'Pattern_Basic','Pattern_Standard','Pattern_Dx','Pattern_Full',
    'Pattern_LOS','Pattern_Paid','Pattern_LOS_Paid'
]

# -----------------------------
# Step 3: Global patterns (all clients combined)
# -----------------------------
global_stats = []

for pat_col in pattern_cols:
    stats = audited.groupby(pat_col).agg(
        Total=('find','count'),
        Hits=('find','sum')
    ).reset_index()
    overall_hit_rate = audited['find'].mean()
    stats['Support'] = stats['Total'] / len(audited)
    stats['HitRate'] = stats['Hits'] / stats['Total']
    stats['Lift'] = stats['HitRate'] / overall_hit_rate if overall_hit_rate > 0 else 0
    stats['Pattern_Type'] = pat_col
    stats['Client'] = 'ALL'
    global_stats.append(stats)

global_stats_df = pd.concat(global_stats, axis=0)

# -----------------------------
# Step 4: Client-specific patterns
# -----------------------------
client_stats = []

for client in audited['clientname'].unique():
    client_data = audited[audited['clientname'] == client].copy()
    overall_hit_rate = client_data['find'].mean()
    
    for pat_col in pattern_cols:
        stats = client_data.groupby(pat_col).agg(
            Total=('find','count'),
            Hits=('find','sum')
        ).reset_index()
        stats['Support'] = stats['Total'] / len(client_data)
        stats['HitRate'] = stats['Hits'] / stats['Total']
        stats['Lift'] = stats['HitRate'] / overall_hit_rate if overall_hit_rate > 0 else 0
        stats['Pattern_Type'] = pat_col
        stats['Client'] = client
        client_stats.append(stats)

client_stats_df = pd.concat(client_stats, axis=0)

# -----------------------------
# Step 5: Test patterns on non-audited claims
# -----------------------------
unaudited['Pattern_Basic'] = unaudited.apply(lambda x: make_pattern(x), axis=1)
unaudited['Pattern_Standard'] = unaudited.apply(lambda x: make_pattern(x, dx_cols=['diag1']), axis=1)
unaudited['Pattern_Dx'] = unaudited.apply(lambda x: make_pattern(x, dx_cols=dx_cols), axis=1)
unaudited['Pattern_Full'] = unaudited.apply(lambda x: make_pattern(x, dx_cols=dx_cols, proc_cols=proc_cols, include_proc=True), axis=1)
unaudited['Pattern_LOS'] = unaudited.apply(lambda x: str(x['soi_indicator']) + "_" + str(x['dischargestatuscode']) + "_" + str(x['LOS_bin']), axis=1)
unaudited['Pattern_Paid'] = unaudited.apply(lambda x: str(x['soi_indicator']) + "_" + str(x['dischargestatuscode']) + "_" + str(x['Paid_bin']), axis=1)
unaudited['Pattern_LOS_Paid'] = unaudited.apply(lambda x: str(x['soi_indicator']) + "_" + str(x['dischargestatuscode']) + "_" + str(x['LOS_bin']) + "_" + str(x['Paid_bin']), axis=1)

test_stats = []
for pat_col in pattern_cols:
    stats = unaudited.groupby(pat_col).agg(
        NonAuditedCount=('soi_indicator','count')
    ).reset_index()
    stats['Pattern_Type'] = pat_col
    test_stats.append(stats)

unaudited_stats_df = pd.concat(test_stats, axis=0)

# -----------------------------
# Step 6: Save outputs
# -----------------------------
global_stats_df.to_csv("global_pattern_stats.csv", index=False)
client_stats_df.to_csv("client_pattern_stats.csv", index=False)
unaudited_stats_df.to_csv("unaudited_pattern_test.csv", index=False)

print("âœ… Global, client, and unaudited pattern stats saved.")
