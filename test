import pandas as pd
import numpy as np

# -----------------------------
# Load data
# -----------------------------
df = pd.read_csv("claims.csv")

# Only audited claims
audited = df[~df['find'].isna()].copy()  # 'find' is NaN for unaudited

# Dx/Proc columns
dx_cols = [f'diag{i}' for i in range(1,7)]   # diag1–6
proc_cols = [f'proc{i}' for i in range(1,7)] # proc1–6

# -----------------------------
# Step 0: Bin numeric features
# -----------------------------
los_bins = [0,2,5,10,15,1000]
los_labels = ['VeryShort','Short','Medium','Long','VeryLong']
audited['LOS_bin'] = pd.cut(audited['los'], bins=los_bins, labels=los_labels)

paid_bins = [0,10000,50000,100000,1000000]
paid_labels = ['Low','Medium','High','VeryHigh']
audited['Paid_bin'] = pd.cut(audited['totalpaidamount'], bins=paid_bins, labels=paid_labels)

# -----------------------------
# Step 1: Helper function to create patterns
# -----------------------------
def make_pattern(row, dx_cols=[], proc_cols=[], include_proc=False):
    dx_part = "_".join([str(row[c]) if pd.notna(row[c]) else "NA" for c in dx_cols])
    proc_part = "_".join([str(row[c]) if pd.notna(row[c]) else "NA" for c in proc_cols]) if include_proc else ""
    parts = [str(row['soi_indicator']), str(row['dischargestatuscode'])]
    if dx_part: parts.append(dx_part)
    if proc_part: parts.append(proc_part)
    return "_".join(parts)

# -----------------------------
# Step 2: Create pattern columns based on priority table
# -----------------------------

# Priority 1
audited['Pattern_Basic'] = audited.apply(lambda x: make_pattern(x), axis=1)
audited['Pattern_Standard'] = audited.apply(lambda x: make_pattern(x, dx_cols=['diag1']), axis=1)

# Priority 2
audited['Pattern_Dx'] = audited.apply(lambda x: make_pattern(x, dx_cols=dx_cols), axis=1)
audited['Pattern_Full'] = audited.apply(lambda x: make_pattern(x, dx_cols=dx_cols, proc_cols=proc_cols, include_proc=True), axis=1)
audited['Pattern_Client'] = audited.apply(lambda x: str(x['clientname']) + "_" + make_pattern(x), axis=1)

# Priority 4
audited['Pattern_LOS'] = audited.apply(lambda x: str(x['soi_indicator']) + "_" + str(x['dischargestatuscode']) + "_" + str(x['LOS_bin']), axis=1)
audited['Pattern_Paid'] = audited.apply(lambda x: str(x['soi_indicator']) + "_" + str(x['dischargestatuscode']) + "_" + str(x['Paid_bin']), axis=1)
audited['Pattern_LOS_Paid'] = audited.apply(lambda x: str(x['soi_indicator']) + "_" + str(x['dischargestatuscode']) + "_" + str(x['LOS_bin']) + "_" + str(x['Paid_bin']), axis=1)

print("✅ All pattern columns created (no loadmonth)")

# -----------------------------
# Step 3: Compute Support, HitRate, Lift per client
# -----------------------------
pattern_cols = [
    'Pattern_Basic','Pattern_Standard','Pattern_Dx','Pattern_Full',
    'Pattern_Client','Pattern_LOS','Pattern_Paid','Pattern_LOS_Paid'
]

all_stats = []

for client in audited['clientname'].unique():
    client_data = audited[audited['clientname'] == client].copy()
    overall_hit_rate = client_data['find'].mean()
    total_client = len(client_data)
    
    for pat_col in pattern_cols:
        stats = client_data.groupby(pat_col).agg(
            Total=('find','count'),
            Hits=('find','sum')
        ).reset_index()
        stats['Support'] = stats['Total'] / total_client
        stats['HitRate'] = stats['Hits'] / stats['Total']
        stats['Lift'] = stats['HitRate'] / overall_hit_rate if overall_hit_rate > 0 else 0
        stats['Client'] = client
        stats['Pattern_Type'] = pat_col
        all_stats.append(stats)

# Combine all clients and patterns
pattern_stats_all = pd.concat(all_stats, axis=0)
pattern_stats_all.to_csv("audited_patterns_all_clients.csv", index=False)

print("✅ Pattern mining completed for all clients. CSV saved as 'audited_patterns_all_clients.csv'")
